<!DOCTYPE html> <html> <head> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1"> <title>聊聊Vue的template编译</title> <meta name="description" content="template模板编译"> <link rel="stylesheet" href="/assets/css/main.css"> <link rel="canonical" href="/jekyll/update/2017/09/10/%E8%81%8A%E8%81%8AVue%E7%9A%84template%E7%BC%96%E8%AF%91.html"> <link rel="alternate" type="application/rss+xml" title="" href="/feed.xml"> <script src="/assets/js/modernizr.js"></script> </head> <body"> <main class="wrapper"> <header class="site-header"> <a href="#navbar" id="menu-burger" class="menu-burger">Menu <span class="nav-icon"></span> <svg x="0px" y="0px" width="54px" height="54px" viewBox="0 0 54 54"> <circle fill="transparent" stroke="#000000" stroke-width="1" cx="27" cy="27" r="25" stroke-dasharray="157 157" stroke-dashoffset="157"></circle> </svg> </a> <div id="navbar" class="navbar"> <div class="navigation-wrapper"> <div class="half-block"> <h2>Navigation</h2> <nav> <ul class="primary-nav"> <li><a href="/">Home</a></li> <li><a href="/blog">Blog</a></li> <li><a href="/about">About</a></li> <li><a href="https://github.com/answershuto" ><i class="icon icon-github"></i> Github</a></li> </ul> </nav> </div> </div> </div> </header> <article class="post" itemscope itemtype="http://schema.org/BlogPosting"> <header class="post-header intro"> <div class="intro-in"> <h1 class="post-title" itemprop="name headline">聊聊Vue的template编译</h1> <p class="post-meta"><time datetime="2017-09-10T19:40:00+08:00" itemprop="datePublished">Sep 10, 2017</time></p> </div> </header> <div class="post-content container" itemprop="articleBody"> <h2 id="mount">$mount</h2> <p>首先看一下mount的代码</p> <div class="highlighter-rouge"><pre class="highlight"><code><span class="cm">/*把原本不带编译的$mount方法保存下来，在最后会调用。*/</span>
<span class="kr">const</span> <span class="nx">mount</span> <span class="o">=</span> <span class="nx">Vue</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">$mount</span>
<span class="cm">/*挂载组件，带模板编译*/</span>
<span class="nx">Vue</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">$mount</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span>
  <span class="nx">el</span><span class="p">?:</span> <span class="nx">string</span> <span class="o">|</span> <span class="nx">Element</span><span class="p">,</span>
  <span class="nx">hydrating</span><span class="p">?:</span> <span class="kr">boolean</span>
<span class="p">)</span><span class="err">:</span> <span class="nx">Component</span> <span class="p">{</span>
  <span class="nx">el</span> <span class="o">=</span> <span class="nx">el</span> <span class="o">&amp;&amp;</span> <span class="nx">query</span><span class="p">(</span><span class="nx">el</span><span class="p">)</span>

  <span class="cm">/* istanbul ignore if */</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">el</span> <span class="o">===</span> <span class="nb">document</span><span class="p">.</span><span class="nx">body</span> <span class="o">||</span> <span class="nx">el</span> <span class="o">===</span> <span class="nb">document</span><span class="p">.</span><span class="nx">documentElement</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">NODE_ENV</span> <span class="o">!==</span> <span class="s1">'production'</span> <span class="o">&amp;&amp;</span> <span class="nx">warn</span><span class="p">(</span>
      <span class="err">`</span><span class="nx">Do</span> <span class="nx">not</span> <span class="nx">mount</span> <span class="nx">Vue</span> <span class="nx">to</span> <span class="o">&lt;</span><span class="nx">html</span><span class="o">&gt;</span> <span class="nx">or</span> <span class="o">&lt;</span><span class="nx">body</span><span class="o">&gt;</span> <span class="o">-</span> <span class="nx">mount</span> <span class="nx">to</span> <span class="nx">normal</span> <span class="nx">elements</span> <span class="nx">instead</span><span class="p">.</span><span class="err">`</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="k">this</span>
  <span class="p">}</span>

  <span class="kr">const</span> <span class="nx">options</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">$options</span>
  <span class="c1">// resolve template/el and convert to render function</span>
  <span class="cm">/*处理模板templete，编译成render函数，render不存在的时候才会编译template，否则优先使用render*/</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">options</span><span class="p">.</span><span class="nx">render</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">template</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">template</span>
    <span class="cm">/*template存在的时候取template，不存在的时候取el的outerHTML*/</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">template</span><span class="p">)</span> <span class="p">{</span>
      <span class="cm">/*当template是字符串的时候*/</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">template</span> <span class="o">===</span> <span class="s1">'string'</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">template</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">===</span> <span class="s1">'#'</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">template</span> <span class="o">=</span> <span class="nx">idToTemplate</span><span class="p">(</span><span class="nx">template</span><span class="p">)</span>
          <span class="cm">/* istanbul ignore if */</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">NODE_ENV</span> <span class="o">!==</span> <span class="s1">'production'</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">template</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">warn</span><span class="p">(</span>
              <span class="err">`</span><span class="nx">Template</span> <span class="nx">element</span> <span class="nx">not</span> <span class="nx">found</span> <span class="nx">or</span> <span class="nx">is</span> <span class="nx">empty</span><span class="err">:</span> <span class="nx">$</span><span class="p">{</span><span class="nx">options</span><span class="p">.</span><span class="nx">template</span><span class="p">}</span><span class="err">`</span><span class="p">,</span>
              <span class="k">this</span>
            <span class="p">)</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">template</span><span class="p">.</span><span class="nx">nodeType</span><span class="p">)</span> <span class="p">{</span>
        <span class="cm">/*当template为DOM节点的时候*/</span>
        <span class="nx">template</span> <span class="o">=</span> <span class="nx">template</span><span class="p">.</span><span class="nx">innerHTML</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="cm">/*报错*/</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">NODE_ENV</span> <span class="o">!==</span> <span class="s1">'production'</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">warn</span><span class="p">(</span><span class="s1">'invalid template option:'</span> <span class="o">+</span> <span class="nx">template</span><span class="p">,</span> <span class="k">this</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="k">this</span>
      <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">el</span><span class="p">)</span> <span class="p">{</span>
      <span class="cm">/*获取element的outerHTML*/</span>
      <span class="nx">template</span> <span class="o">=</span> <span class="nx">getOuterHTML</span><span class="p">(</span><span class="nx">el</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">template</span><span class="p">)</span> <span class="p">{</span>
      <span class="cm">/* istanbul ignore if */</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">NODE_ENV</span> <span class="o">!==</span> <span class="s1">'production'</span> <span class="o">&amp;&amp;</span> <span class="nx">config</span><span class="p">.</span><span class="nx">performance</span> <span class="o">&amp;&amp;</span> <span class="nx">mark</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">mark</span><span class="p">(</span><span class="s1">'compile'</span><span class="p">)</span>
      <span class="p">}</span>

      <span class="cm">/*将template编译成render函数，这里会有render以及staticRenderFns两个返回，这是vue的编译时优化，static静态不需要在VNode更新时进行patch，优化性能*/</span>
      <span class="kr">const</span> <span class="p">{</span> <span class="nx">render</span><span class="p">,</span> <span class="nx">staticRenderFns</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">compileToFunctions</span><span class="p">(</span><span class="nx">template</span><span class="p">,</span> <span class="p">{</span>
        <span class="nx">shouldDecodeNewlines</span><span class="p">,</span>
        <span class="na">delimiters</span><span class="p">:</span> <span class="nx">options</span><span class="p">.</span><span class="nx">delimiters</span>
      <span class="p">},</span> <span class="k">this</span><span class="p">)</span>
      <span class="nx">options</span><span class="p">.</span><span class="nx">render</span> <span class="o">=</span> <span class="nx">render</span>
      <span class="nx">options</span><span class="p">.</span><span class="nx">staticRenderFns</span> <span class="o">=</span> <span class="nx">staticRenderFns</span>

      <span class="cm">/* istanbul ignore if */</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">NODE_ENV</span> <span class="o">!==</span> <span class="s1">'production'</span> <span class="o">&amp;&amp;</span> <span class="nx">config</span><span class="p">.</span><span class="nx">performance</span> <span class="o">&amp;&amp;</span> <span class="nx">mark</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">mark</span><span class="p">(</span><span class="s1">'compile end'</span><span class="p">)</span>
        <span class="nx">measure</span><span class="p">(</span><span class="err">`</span><span class="nx">$</span><span class="p">{</span><span class="k">this</span><span class="p">.</span><span class="nx">_name</span><span class="p">}</span> <span class="nx">compile</span><span class="err">`</span><span class="p">,</span> <span class="s1">'compile'</span><span class="p">,</span> <span class="s1">'compile end'</span><span class="p">)</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="cm">/*Github:https://github.com/answershuto*/</span>
  <span class="cm">/*调用const mount = Vue.prototype.$mount保存下来的不带编译的mount*/</span>
  <span class="k">return</span> <span class="nx">mount</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">el</span><span class="p">,</span> <span class="nx">hydrating</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div> <p>通过mount代码我们可以看到，在mount的过程中，如果render函数不存在（render函数存在会优先使用render）会将template进行compileToFunctions得到render以及staticRenderFns。譬如说手写render function时加入了template的情况都会在运行时进行编译。而render function在运行后会返回VNode节点，供页面的渲染以及在update的时候patch。接下来我们来看一下template是如何编译的。</p> <h2 id="section">一些基础</h2> <p>首先，template会被编译成AST语法树，那么AST是什么？</p> <p>在计算机科学中，抽象语法树（abstract syntax tree或者缩写为AST），或者语法树（syntax tree），是源代码的抽象语法结构的树状表现形式，这里特指编程语言的源代码。具体可以查看<a href="https://zh.wikipedia.org/wiki/%E6%8A%BD%E8%B1%A1%E8%AA%9E%E6%B3%95%E6%A8%B9">抽象语法树</a>。</p> <p>AST会经过generate得到render函数，render的返回值是VNode，VNode是Vue的虚拟DOM节点，具体定义如下：</p> <div class="highlighter-rouge"><pre class="highlight"><code><span class="kr">export</span> <span class="k">default</span> <span class="kr">class</span> <span class="nx">VNode</span> <span class="p">{</span>
  <span class="nl">tag</span><span class="p">:</span> <span class="nx">string</span> <span class="o">|</span> <span class="k">void</span><span class="p">;</span>
  <span class="nl">data</span><span class="p">:</span> <span class="nx">VNodeData</span> <span class="o">|</span> <span class="k">void</span><span class="p">;</span>
  <span class="nl">children</span><span class="p">:</span> <span class="p">?</span><span class="nb">Array</span><span class="o">&lt;</span><span class="nx">VNode</span><span class="o">&gt;</span><span class="p">;</span>
  <span class="nl">text</span><span class="p">:</span> <span class="nx">string</span> <span class="o">|</span> <span class="k">void</span><span class="p">;</span>
  <span class="nl">elm</span><span class="p">:</span> <span class="nx">Node</span> <span class="o">|</span> <span class="k">void</span><span class="p">;</span>
  <span class="nl">ns</span><span class="p">:</span> <span class="nx">string</span> <span class="o">|</span> <span class="k">void</span><span class="p">;</span>
  <span class="nl">context</span><span class="p">:</span> <span class="nx">Component</span> <span class="o">|</span> <span class="k">void</span><span class="p">;</span> <span class="c1">// rendered in this component's scope</span>
  <span class="nl">functionalContext</span><span class="p">:</span> <span class="nx">Component</span> <span class="o">|</span> <span class="k">void</span><span class="p">;</span> <span class="c1">// only for functional component root nodes</span>
  <span class="nl">key</span><span class="p">:</span> <span class="nx">string</span> <span class="o">|</span> <span class="nx">number</span> <span class="o">|</span> <span class="k">void</span><span class="p">;</span>
  <span class="nl">componentOptions</span><span class="p">:</span> <span class="nx">VNodeComponentOptions</span> <span class="o">|</span> <span class="k">void</span><span class="p">;</span>
  <span class="nl">componentInstance</span><span class="p">:</span> <span class="nx">Component</span> <span class="o">|</span> <span class="k">void</span><span class="p">;</span> <span class="c1">// component instance</span>
  <span class="nl">parent</span><span class="p">:</span> <span class="nx">VNode</span> <span class="o">|</span> <span class="k">void</span><span class="p">;</span> <span class="c1">// component placeholder node</span>
  <span class="nl">raw</span><span class="p">:</span> <span class="kr">boolean</span><span class="p">;</span> <span class="c1">// contains raw HTML? (server only)</span>
  <span class="nl">isStatic</span><span class="p">:</span> <span class="kr">boolean</span><span class="p">;</span> <span class="c1">// hoisted static node</span>
  <span class="nl">isRootInsert</span><span class="p">:</span> <span class="kr">boolean</span><span class="p">;</span> <span class="c1">// necessary for enter transition check</span>
  <span class="nl">isComment</span><span class="p">:</span> <span class="kr">boolean</span><span class="p">;</span> <span class="c1">// empty comment placeholder?</span>
  <span class="nl">isCloned</span><span class="p">:</span> <span class="kr">boolean</span><span class="p">;</span> <span class="c1">// is a cloned node?</span>
  <span class="nl">isOnce</span><span class="p">:</span> <span class="kr">boolean</span><span class="p">;</span> <span class="c1">// is a v-once node?</span>
  <span class="cm">/*Github:https://github.com/answershuto*/</span>
  
  <span class="nx">constructor</span> <span class="p">(</span>
    <span class="nx">tag</span><span class="p">?:</span> <span class="nx">string</span><span class="p">,</span>
    <span class="nx">data</span><span class="p">?:</span> <span class="nx">VNodeData</span><span class="p">,</span>
    <span class="nx">children</span><span class="p">?:</span> <span class="p">?</span><span class="nb">Array</span><span class="o">&lt;</span><span class="nx">VNode</span><span class="o">&gt;</span><span class="p">,</span>
    <span class="nx">text</span><span class="p">?:</span> <span class="nx">string</span><span class="p">,</span>
    <span class="nx">elm</span><span class="p">?:</span> <span class="nx">Node</span><span class="p">,</span>
    <span class="nx">context</span><span class="p">?:</span> <span class="nx">Component</span><span class="p">,</span>
    <span class="nx">componentOptions</span><span class="p">?:</span> <span class="nx">VNodeComponentOptions</span>
  <span class="p">)</span> <span class="p">{</span>
    <span class="cm">/*当前节点的标签名*/</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">tag</span> <span class="o">=</span> <span class="nx">tag</span>
    <span class="cm">/*当前节点对应的对象，包含了具体的一些数据信息，是一个VNodeData类型，可以参考VNodeData类型中的数据信息*/</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">data</span> <span class="o">=</span> <span class="nx">data</span>
    <span class="cm">/*当前节点的子节点，是一个数组*/</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">children</span> <span class="o">=</span> <span class="nx">children</span>
    <span class="cm">/*当前节点的文本*/</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">text</span> <span class="o">=</span> <span class="nx">text</span>
    <span class="cm">/*当前虚拟节点对应的真实dom节点*/</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">elm</span> <span class="o">=</span> <span class="nx">elm</span>
    <span class="cm">/*当前节点的名字空间*/</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">ns</span> <span class="o">=</span> <span class="kc">undefined</span>
    <span class="cm">/*编译作用域*/</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">context</span> <span class="o">=</span> <span class="nx">context</span>
    <span class="cm">/*函数化组件作用域*/</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">functionalContext</span> <span class="o">=</span> <span class="kc">undefined</span>
    <span class="cm">/*节点的key属性，被当作节点的标志，用以优化*/</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">key</span> <span class="o">=</span> <span class="nx">data</span> <span class="o">&amp;&amp;</span> <span class="nx">data</span><span class="p">.</span><span class="nx">key</span>
    <span class="cm">/*组件的option选项*/</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">componentOptions</span> <span class="o">=</span> <span class="nx">componentOptions</span>
    <span class="cm">/*当前节点对应的组件的实例*/</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">componentInstance</span> <span class="o">=</span> <span class="kc">undefined</span>
    <span class="cm">/*当前节点的父节点*/</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">parent</span> <span class="o">=</span> <span class="kc">undefined</span>
    <span class="cm">/*简而言之就是是否为原生HTML或只是普通文本，innerHTML的时候为true，textContent的时候为false*/</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">raw</span> <span class="o">=</span> <span class="kc">false</span>
    <span class="cm">/*静态节点标志*/</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">isStatic</span> <span class="o">=</span> <span class="kc">false</span>
    <span class="cm">/*是否作为跟节点插入*/</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">isRootInsert</span> <span class="o">=</span> <span class="kc">true</span>
    <span class="cm">/*是否为注释节点*/</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">isComment</span> <span class="o">=</span> <span class="kc">false</span>
    <span class="cm">/*是否为克隆节点*/</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">isCloned</span> <span class="o">=</span> <span class="kc">false</span>
    <span class="cm">/*是否有v-once指令*/</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">isOnce</span> <span class="o">=</span> <span class="kc">false</span>
  <span class="p">}</span>

  <span class="c1">// DEPRECATED: alias for componentInstance for backwards compat.</span>
  <span class="cm">/* istanbul ignore next */</span>
  <span class="nx">get</span> <span class="nx">child</span> <span class="p">():</span> <span class="nx">Component</span> <span class="o">|</span> <span class="k">void</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">componentInstance</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div> <p>关于VNode的一些细节，请参考<a href="https://github.com/answershuto/learnVue/blob/master/docs/VNode%E8%8A%82%E7%82%B9.MarkDown">VNode节点</a>。</p> <h2 id="createcompiler">createCompiler</h2> <p>createCompiler用以创建编译器，返回值是compile以及compileToFunctions。compile是一个编译器，它会将传入的template转换成对应的AST树、render函数以及staticRenderFns函数。而compileToFunctions则是带缓存的编译器，同时staticRenderFns以及render函数会被转换成Funtion对象。</p> <p>因为不同平台有一些不同的options，所以createCompiler会根据平台区分传入一个baseOptions，会与compile本身传入的options合并得到最终的finalOptions。</p> <h2 id="compiletofunctions">compileToFunctions</h2> <p>首先还是贴一下compileToFunctions的代码。</p> <div class="highlighter-rouge"><pre class="highlight"><code>  <span class="cm">/*带缓存的编译器，同时staticRenderFns以及render函数会被转换成Funtion对象*/</span>
  <span class="kd">function</span> <span class="nx">compileToFunctions</span> <span class="p">(</span>
    <span class="nx">template</span><span class="err">:</span> <span class="nx">string</span><span class="p">,</span>
    <span class="nx">options</span><span class="p">?:</span> <span class="nx">CompilerOptions</span><span class="p">,</span>
    <span class="nx">vm</span><span class="p">?:</span> <span class="nx">Component</span>
  <span class="p">)</span><span class="err">:</span> <span class="nx">CompiledFunctionResult</span> <span class="p">{</span>
    <span class="nx">options</span> <span class="o">=</span> <span class="nx">options</span> <span class="o">||</span> <span class="p">{}</span>

    <span class="cm">/* istanbul ignore if */</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">NODE_ENV</span> <span class="o">!==</span> <span class="s1">'production'</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// detect possible CSP restriction</span>
      <span class="k">try</span> <span class="p">{</span>
        <span class="k">new</span> <span class="nb">Function</span><span class="p">(</span><span class="s1">'return 1'</span><span class="p">)</span>
      <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">toString</span><span class="p">().</span><span class="nx">match</span><span class="p">(</span><span class="sr">/unsafe-eval|CSP/</span><span class="p">))</span> <span class="p">{</span>
          <span class="nx">warn</span><span class="p">(</span>
            <span class="s1">'It seems you are using the standalone build of Vue.js in an '</span> <span class="o">+</span>
            <span class="s1">'environment with Content Security Policy that prohibits unsafe-eval. '</span> <span class="o">+</span>
            <span class="s1">'The template compiler cannot work in this environment. Consider '</span> <span class="o">+</span>
            <span class="s1">'relaxing the policy to allow unsafe-eval or pre-compiling your '</span> <span class="o">+</span>
            <span class="s1">'templates into render functions.'</span>
          <span class="p">)</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="cm">/*Github:https://github.com/answershuto*/</span>
    <span class="c1">// check cache</span>
    <span class="cm">/*有缓存的时候直接取出缓存中的结果即可*/</span>
    <span class="kr">const</span> <span class="nx">key</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">delimiters</span>
      <span class="p">?</span> <span class="nb">String</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">delimiters</span><span class="p">)</span> <span class="o">+</span> <span class="nx">template</span>
      <span class="p">:</span> <span class="nx">template</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">functionCompileCache</span><span class="p">[</span><span class="nx">key</span><span class="p">])</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">functionCompileCache</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span>
    <span class="p">}</span>

    <span class="c1">// compile</span>
    <span class="cm">/*编译*/</span>
    <span class="kr">const</span> <span class="nx">compiled</span> <span class="o">=</span> <span class="nx">compile</span><span class="p">(</span><span class="nx">template</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span>

    <span class="c1">// check compilation errors/tips</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">NODE_ENV</span> <span class="o">!==</span> <span class="s1">'production'</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">compiled</span><span class="p">.</span><span class="nx">errors</span> <span class="o">&amp;&amp;</span> <span class="nx">compiled</span><span class="p">.</span><span class="nx">errors</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">warn</span><span class="p">(</span>
          <span class="err">`</span><span class="nb">Error</span> <span class="nx">compiling</span> <span class="nx">template</span><span class="err">:\</span><span class="nx">n</span><span class="err">\</span><span class="nx">n$</span><span class="p">{</span><span class="nx">template</span><span class="p">}</span><span class="err">\</span><span class="nx">n</span><span class="err">\</span><span class="nx">n</span><span class="err">`</span> <span class="o">+</span>
          <span class="nx">compiled</span><span class="p">.</span><span class="nx">errors</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">e</span> <span class="o">=&gt;</span> <span class="err">`</span><span class="o">-</span> <span class="nx">$</span><span class="p">{</span><span class="nx">e</span><span class="p">}</span><span class="err">`</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s1">'\n'</span><span class="p">)</span> <span class="o">+</span> <span class="s1">'\n'</span><span class="p">,</span>
          <span class="nx">vm</span>
        <span class="p">)</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">compiled</span><span class="p">.</span><span class="nx">tips</span> <span class="o">&amp;&amp;</span> <span class="nx">compiled</span><span class="p">.</span><span class="nx">tips</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">compiled</span><span class="p">.</span><span class="nx">tips</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">msg</span> <span class="o">=&gt;</span> <span class="nx">tip</span><span class="p">(</span><span class="nx">msg</span><span class="p">,</span> <span class="nx">vm</span><span class="p">))</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// turn code into functions</span>
    <span class="kr">const</span> <span class="nx">res</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="kr">const</span> <span class="nx">fnGenErrors</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="cm">/*将render转换成Funtion对象*/</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">render</span> <span class="o">=</span> <span class="nx">makeFunction</span><span class="p">(</span><span class="nx">compiled</span><span class="p">.</span><span class="nx">render</span><span class="p">,</span> <span class="nx">fnGenErrors</span><span class="p">)</span>
    <span class="cm">/*将staticRenderFns全部转化成Funtion对象 */</span>
    <span class="kr">const</span> <span class="nx">l</span> <span class="o">=</span> <span class="nx">compiled</span><span class="p">.</span><span class="nx">staticRenderFns</span><span class="p">.</span><span class="nx">length</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">staticRenderFns</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">(</span><span class="nx">l</span><span class="p">)</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">l</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">staticRenderFns</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">makeFunction</span><span class="p">(</span><span class="nx">compiled</span><span class="p">.</span><span class="nx">staticRenderFns</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">fnGenErrors</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="c1">// check function generation errors.</span>
    <span class="c1">// this should only happen if there is a bug in the compiler itself.</span>
    <span class="c1">// mostly for codegen development use</span>
    <span class="cm">/* istanbul ignore if */</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">NODE_ENV</span> <span class="o">!==</span> <span class="s1">'production'</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="nx">compiled</span><span class="p">.</span><span class="nx">errors</span> <span class="o">||</span> <span class="o">!</span><span class="nx">compiled</span><span class="p">.</span><span class="nx">errors</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">fnGenErrors</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">warn</span><span class="p">(</span>
          <span class="err">`</span><span class="nx">Failed</span> <span class="nx">to</span> <span class="nx">generate</span> <span class="nx">render</span> <span class="kd">function</span><span class="err">:\</span><span class="nx">n</span><span class="err">\</span><span class="nx">n</span><span class="err">`</span> <span class="o">+</span>
          <span class="nx">fnGenErrors</span><span class="p">.</span><span class="nx">map</span><span class="p">(({</span> <span class="nx">err</span><span class="p">,</span> <span class="nx">code</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="err">`</span><span class="nx">$</span><span class="p">{</span><span class="nx">err</span><span class="p">.</span><span class="nx">toString</span><span class="p">()}</span> <span class="k">in</span><span class="err">\</span><span class="nx">n</span><span class="err">\</span><span class="nx">n$</span><span class="p">{</span><span class="nx">code</span><span class="p">}</span><span class="err">\</span><span class="nx">n</span><span class="err">`</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s1">'\n'</span><span class="p">),</span>
          <span class="nx">vm</span>
        <span class="p">)</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="cm">/*存放在缓存中，以免每次都重新编译*/</span>
    <span class="k">return</span> <span class="p">(</span><span class="nx">functionCompileCache</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">res</span><span class="p">)</span> 
  <span class="p">}</span>
</code></pre></div> <p>我们可以发现，在闭包中，会有一个functionCompileCache对象作为缓存器。</p> <div class="highlighter-rouge"><pre class="highlight"><code>  <span class="cm">/*作为缓存，防止每次都重新编译*/</span>
  <span class="kr">const</span> <span class="nx">functionCompileCache</span><span class="err">:</span> <span class="p">{</span>
    <span class="p">[</span><span class="nx">key</span><span class="err">:</span> <span class="nx">string</span><span class="p">]</span><span class="err">:</span> <span class="nx">CompiledFunctionResult</span><span class="p">;</span>
  <span class="p">}</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="kc">null</span><span class="p">)</span>
</code></pre></div> <p>在进入compileToFunctions以后，会先检查缓存中是否有已经编译好的结果，如果有结果则直接从缓存中读取。这样做防止每次同样的模板都要进行重复的编译工作。</p> <div class="highlighter-rouge"><pre class="highlight"><code>    <span class="c1">// check cache</span>
    <span class="cm">/*有缓存的时候直接取出缓存中的结果即可*/</span>
    <span class="kr">const</span> <span class="nx">key</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">delimiters</span>
      <span class="p">?</span> <span class="nb">String</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">delimiters</span><span class="p">)</span> <span class="o">+</span> <span class="nx">template</span>
      <span class="p">:</span> <span class="nx">template</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">functionCompileCache</span><span class="p">[</span><span class="nx">key</span><span class="p">])</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">functionCompileCache</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span>
    <span class="p">}</span>
</code></pre></div> <p>在compileToFunctions的末尾会将编译结果进行缓存</p> <div class="highlighter-rouge"><pre class="highlight"><code>  <span class="cm">/*存放在缓存中，以免每次都重新编译*/</span>
  <span class="k">return</span> <span class="p">(</span><span class="nx">functionCompileCache</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">res</span><span class="p">)</span> 
</code></pre></div> <h2 id="compile">compile</h2> <div class="highlighter-rouge"><pre class="highlight"><code>  <span class="cm">/*编译，将模板template编译成AST树、render函数以及staticRenderFns函数*/</span>
  <span class="kd">function</span> <span class="nx">compile</span> <span class="p">(</span>
    <span class="nx">template</span><span class="err">:</span> <span class="nx">string</span><span class="p">,</span>
    <span class="nx">options</span><span class="p">?:</span> <span class="nx">CompilerOptions</span>
  <span class="p">)</span><span class="err">:</span> <span class="nx">CompiledResult</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">finalOptions</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="nx">baseOptions</span><span class="p">)</span>
    <span class="kr">const</span> <span class="nx">errors</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="kr">const</span> <span class="nx">tips</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="nx">finalOptions</span><span class="p">.</span><span class="nx">warn</span> <span class="o">=</span> <span class="p">(</span><span class="nx">msg</span><span class="p">,</span> <span class="nx">tip</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="p">(</span><span class="nx">tip</span> <span class="p">?</span> <span class="nx">tips</span> <span class="p">:</span> <span class="nx">errors</span><span class="p">).</span><span class="nx">push</span><span class="p">(</span><span class="nx">msg</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="cm">/*做下面这些merge的目的因为不同平台可以提供自己本身平台的一个baseOptions，内部封装了平台自己的实现，然后把共同的部分抽离开来放在这层compiler中，所以在这里需要merge一下*/</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// merge custom modules</span>
      <span class="cm">/*合并modules*/</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">modules</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">finalOptions</span><span class="p">.</span><span class="nx">modules</span> <span class="o">=</span> <span class="p">(</span><span class="nx">baseOptions</span><span class="p">.</span><span class="nx">modules</span> <span class="o">||</span> <span class="p">[]).</span><span class="nx">concat</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">modules</span><span class="p">)</span>
      <span class="p">}</span>
      <span class="c1">// merge custom directives</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">directives</span><span class="p">)</span> <span class="p">{</span>
        <span class="cm">/*合并directives*/</span>
        <span class="nx">finalOptions</span><span class="p">.</span><span class="nx">directives</span> <span class="o">=</span> <span class="nx">extend</span><span class="p">(</span>
          <span class="nb">Object</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="nx">baseOptions</span><span class="p">.</span><span class="nx">directives</span><span class="p">),</span>
          <span class="nx">options</span><span class="p">.</span><span class="nx">directives</span>
        <span class="p">)</span>
      <span class="p">}</span>
      <span class="c1">// copy other options</span>
      <span class="k">for</span> <span class="p">(</span><span class="kr">const</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
        <span class="cm">/*合并其余的options，modules与directives已经在上面做了特殊处理了*/</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">key</span> <span class="o">!==</span> <span class="s1">'modules'</span> <span class="o">&amp;&amp;</span> <span class="nx">key</span> <span class="o">!==</span> <span class="s1">'directives'</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">finalOptions</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">options</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="cm">/*基础模板编译，得到编译结果*/</span>
    <span class="kr">const</span> <span class="nx">compiled</span> <span class="o">=</span> <span class="nx">baseCompile</span><span class="p">(</span><span class="nx">template</span><span class="p">,</span> <span class="nx">finalOptions</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">NODE_ENV</span> <span class="o">!==</span> <span class="s1">'production'</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">errors</span><span class="p">.</span><span class="nx">push</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">errors</span><span class="p">,</span> <span class="nx">detectErrors</span><span class="p">(</span><span class="nx">compiled</span><span class="p">.</span><span class="nx">ast</span><span class="p">))</span>
    <span class="p">}</span>
    <span class="nx">compiled</span><span class="p">.</span><span class="nx">errors</span> <span class="o">=</span> <span class="nx">errors</span>
    <span class="nx">compiled</span><span class="p">.</span><span class="nx">tips</span> <span class="o">=</span> <span class="nx">tips</span>
    <span class="k">return</span> <span class="nx">compiled</span>
  <span class="p">}</span>
</code></pre></div> <p>compile主要做了两件事，一件是合并option（前面说的将平台自有的option与传入的option进行合并），另一件是baseCompile，进行模板template的编译。</p> <p>来看一下baseCompile</p> <h2 id="basecompile">baseCompile</h2> <div class="highlighter-rouge"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">baseCompile</span> <span class="p">(</span>
  <span class="nx">template</span><span class="err">:</span> <span class="nx">string</span><span class="p">,</span>
  <span class="nx">options</span><span class="err">:</span> <span class="nx">CompilerOptions</span>
<span class="p">)</span><span class="err">:</span> <span class="nx">CompiledResult</span> <span class="p">{</span>
  <span class="cm">/*parse解析得到ast树*/</span>
  <span class="kr">const</span> <span class="nx">ast</span> <span class="o">=</span> <span class="nx">parse</span><span class="p">(</span><span class="nx">template</span><span class="p">.</span><span class="nx">trim</span><span class="p">(),</span> <span class="nx">options</span><span class="p">)</span>
  <span class="cm">/*
    将AST树进行优化
    优化的目标：生成模板AST树，检测不需要进行DOM改变的静态子树。
    一旦检测到这些静态树，我们就能做以下这些事情：
    1.把它们变成常数，这样我们就再也不需要每次重新渲染时创建新的节点了。
    2.在patch的过程中直接跳过。
 */</span>
  <span class="nx">optimize</span><span class="p">(</span><span class="nx">ast</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span>
  <span class="cm">/*根据ast树生成所需的code（内部包含render与staticRenderFns）*/</span>
  <span class="kr">const</span> <span class="nx">code</span> <span class="o">=</span> <span class="nx">generate</span><span class="p">(</span><span class="nx">ast</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span>
  <span class="k">return</span> <span class="p">{</span>
    <span class="nx">ast</span><span class="p">,</span>
    <span class="na">render</span><span class="p">:</span> <span class="nx">code</span><span class="p">.</span><span class="nx">render</span><span class="p">,</span>
    <span class="na">staticRenderFns</span><span class="p">:</span> <span class="nx">code</span><span class="p">.</span><span class="nx">staticRenderFns</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div> <p>baseCompile首先会将模板template进行parse得到一个AST语法树，再通过optimize做一些优化，最后通过generate得到render以及staticRenderFns。</p> <h3 id="parse">parse</h3> <p>parse的源码可以参见<a href="https://github.com/answershuto/learnVue/blob/master/vue-src/compiler/parser/index.js#L53">https://github.com/answershuto/learnVue/blob/master/vue-src/compiler/parser/index.js#L53</a>。</p> <p>parse会用正则等方式解析template模板中的指令、class、style等数据，形成AST语法树。</p> <h3 id="optimize">optimize</h3> <p>optimize的主要作用是标记static静态节点，这是Vue在编译过程中的一处优化，后面当update更新界面时，会有一个patch的过程，diff算法会直接跳过静态节点，从而减少了比较的过程，优化了patch的性能。</p> <h3 id="generate">generate</h3> <p>generate是将AST语法树转化成render funtion字符串的过程，得到结果是render的字符串以及staticRenderFns字符串。</p> <hr /> <p>至此，我们的template模板已经被转化成了我们所需的AST语法树、render function字符串以及staticRenderFns字符串。</p> <h2 id="section-1">举个例子</h2> <p>来看一下这段代码的编译结果</p> <div class="highlighter-rouge"><pre class="highlight"><code><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"main"</span> <span class="na">:class=</span><span class="s">"bindClass"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div&gt;&lt;/div&gt;</span>
    <span class="nt">&lt;div&gt;</span>hello world<span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">v-for=</span><span class="s">"(item, index) in arr"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;p&gt;&lt;/p&gt;</span>
        <span class="nt">&lt;p&gt;&lt;/p&gt;</span>
        <span class="nt">&lt;p&gt;&lt;/p&gt;</span>
        <span class="nt">&lt;p&gt;</span>---<span class="nt">&lt;/p&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">v-if=</span><span class="s">"text"</span><span class="nt">&gt;</span>
        
    <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">v-else</span><span class="nt">&gt;&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</code></pre></div> <p>转化后得到AST树，如下图：</p> <p><img src="https://i.loli.net/2017/09/07/59b135001cbfa.png" alt="img" /></p> <p>我们可以看到最外层的div是这颗AST树的根节点，节点上有许多数据代表这个节点的形态，比如static表示是否是静态节点，staticClass表示静态class属性（非bind:class）。children代表该节点的子节点，可以看到children是一个长度为4的数组，里面包含的是该节点下的四个div子节点。children里面的节点与父节点的结构类似，层层往下形成一棵AST语法树。</p> <p>再来看看由AST得到的render函数</p> <div class="highlighter-rouge"><pre class="highlight"><code><span class="kd">with</span><span class="p">(</span><span class="k">this</span><span class="p">){</span>
    <span class="k">return</span> <span class="nx">_c</span><span class="p">(</span>  <span class="s1">'div'</span><span class="p">,</span>
                <span class="p">{</span>
                    <span class="cm">/*static class*/</span>
                    <span class="na">staticClass</span><span class="p">:</span><span class="s2">"main"</span><span class="p">,</span>
                    <span class="cm">/*bind class*/</span>
                    <span class="na">class</span><span class="p">:</span><span class="nx">bindClass</span>
                <span class="p">},</span>
                <span class="p">[</span>
                    <span class="nx">_c</span><span class="p">(</span> <span class="s1">'div'</span><span class="p">,</span> <span class="p">[</span><span class="nx">_v</span><span class="p">(</span><span class="nx">_s</span><span class="p">(</span><span class="nx">text</span><span class="p">))]),</span>
                    <span class="nx">_c</span><span class="p">(</span><span class="s1">'div'</span><span class="p">,[</span><span class="nx">_v</span><span class="p">(</span><span class="s2">"hello world"</span><span class="p">)]),</span>
                    <span class="cm">/*这是一个v-for循环*/</span>
                    <span class="nx">_l</span><span class="p">(</span>
                        <span class="p">(</span><span class="nx">arr</span><span class="p">),</span>
                        <span class="kd">function</span><span class="p">(</span><span class="nx">item</span><span class="p">,</span><span class="nx">index</span><span class="p">){</span>
                            <span class="k">return</span> <span class="nx">_c</span><span class="p">(</span>  <span class="s1">'div'</span><span class="p">,</span>
                                        <span class="p">[</span><span class="nx">_c</span><span class="p">(</span><span class="s1">'p'</span><span class="p">,[</span><span class="nx">_v</span><span class="p">(</span><span class="nx">_s</span><span class="p">(</span><span class="nx">item</span><span class="p">.</span><span class="nx">name</span><span class="p">))]),</span>
                                        <span class="nx">_c</span><span class="p">(</span><span class="s1">'p'</span><span class="p">,[</span><span class="nx">_v</span><span class="p">(</span><span class="nx">_s</span><span class="p">(</span><span class="nx">item</span><span class="p">.</span><span class="nx">value</span><span class="p">))]),</span>
                                        <span class="nx">_c</span><span class="p">(</span><span class="s1">'p'</span><span class="p">,[</span><span class="nx">_v</span><span class="p">(</span><span class="nx">_s</span><span class="p">(</span><span class="nx">index</span><span class="p">))]),</span>
                                        <span class="nx">_c</span><span class="p">(</span><span class="s1">'p'</span><span class="p">,[</span><span class="nx">_v</span><span class="p">(</span><span class="s2">"---"</span><span class="p">)])]</span>
                                    <span class="p">)</span>
                        <span class="p">}</span>
                    <span class="p">),</span>
                    <span class="cm">/*这是v-if*/</span>
                    <span class="p">(</span><span class="nx">text</span><span class="p">)?</span><span class="nx">_c</span><span class="p">(</span><span class="s1">'div'</span><span class="p">,[</span><span class="nx">_v</span><span class="p">(</span><span class="nx">_s</span><span class="p">(</span><span class="nx">text</span><span class="p">))]):</span><span class="nx">_c</span><span class="p">(</span><span class="s1">'div'</span><span class="p">,[</span><span class="nx">_v</span><span class="p">(</span><span class="s2">"no text"</span><span class="p">)])],</span>
                    <span class="mi">2</span>
            <span class="p">)</span>
<span class="p">}</span>
</code></pre></div> <h2 id="cvsq">_c，_v，_s，_q</h2> <p>看了render function字符串，发现有大量的_c，_v，_s，_q，这些函数究竟是什么？</p> <p>带着问题，我们来看一下<a href="https://github.com/answershuto/learnVue/blob/master/vue-src/core/instance/render.js#L124">core/instance/render</a>。</p> <div class="highlighter-rouge"><pre class="highlight"><code><span class="cm">/*处理v-once的渲染函数*/</span>
  <span class="nx">Vue</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_o</span> <span class="o">=</span> <span class="nx">markOnce</span>
  <span class="cm">/*将字符串转化为数字，如果转换失败会返回原字符串*/</span>
  <span class="nx">Vue</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_n</span> <span class="o">=</span> <span class="nx">toNumber</span>
  <span class="cm">/*将val转化成字符串*/</span>
  <span class="nx">Vue</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_s</span> <span class="o">=</span> <span class="nx">toString</span>
  <span class="cm">/*处理v-for列表渲染*/</span>
  <span class="nx">Vue</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_l</span> <span class="o">=</span> <span class="nx">renderList</span>
  <span class="cm">/*处理slot的渲染*/</span>
  <span class="nx">Vue</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_t</span> <span class="o">=</span> <span class="nx">renderSlot</span>
  <span class="cm">/*检测两个变量是否相等*/</span>
  <span class="nx">Vue</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_q</span> <span class="o">=</span> <span class="nx">looseEqual</span>
  <span class="cm">/*检测arr数组中是否包含与val变量相等的项*/</span>
  <span class="nx">Vue</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_i</span> <span class="o">=</span> <span class="nx">looseIndexOf</span>
  <span class="cm">/*处理static树的渲染*/</span>
  <span class="nx">Vue</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_m</span> <span class="o">=</span> <span class="nx">renderStatic</span>
  <span class="cm">/*处理filters*/</span>
  <span class="nx">Vue</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_f</span> <span class="o">=</span> <span class="nx">resolveFilter</span>
  <span class="cm">/*从config配置中检查eventKeyCode是否存在*/</span>
  <span class="nx">Vue</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_k</span> <span class="o">=</span> <span class="nx">checkKeyCodes</span>
  <span class="cm">/*合并v-bind指令到VNode中*/</span>
  <span class="nx">Vue</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_b</span> <span class="o">=</span> <span class="nx">bindObjectProps</span>
  <span class="cm">/*创建一个文本节点*/</span>
  <span class="nx">Vue</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_v</span> <span class="o">=</span> <span class="nx">createTextVNode</span>
  <span class="cm">/*创建一个空VNode节点*/</span>
  <span class="nx">Vue</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_e</span> <span class="o">=</span> <span class="nx">createEmptyVNode</span>
  <span class="cm">/*处理ScopedSlots*/</span>
  <span class="nx">Vue</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_u</span> <span class="o">=</span> <span class="nx">resolveScopedSlots</span>

  <span class="cm">/*创建VNode节点*/</span>
  <span class="nx">vm</span><span class="p">.</span><span class="nx">_c</span> <span class="o">=</span> <span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">c</span><span class="p">,</span> <span class="nx">d</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">createElement</span><span class="p">(</span><span class="nx">vm</span><span class="p">,</span> <span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">c</span><span class="p">,</span> <span class="nx">d</span><span class="p">,</span> <span class="kc">false</span><span class="p">)</span>
</code></pre></div> <p>通过这些函数，render函数最后会返回一个VNode节点，在_update的时候，经过patch与之前的VNode节点进行比较，得出差异后将这些差异渲染到真实的DOM上。</p> </div> </article> <footer class="site-footer"> <div class="container"> <ul class="social"> <li><a href="http://github.com/answershuto" target="_blank"><i class="icon icon-github"></i></a></li> </ul> <p> <br><small>&copy;2018 CaoYang , All rights reserved.</small> </p> </div> </footer> </main> <script src="/assets/js/jquery-2.1.1.js"></script> <script src="/assets/js/main.js"></script> </body> </html><!-- by nandomoreira.me -->